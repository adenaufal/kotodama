name: Release Artifacts on Tag

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write # Needed to upload assets to the existing GitHub Release.

jobs:
  build-and-attach:
    name: Build and attach release artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch full history so npm/yarn tooling can read tags if needed.

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Package build output
        id: package
        run: |
          set -euo pipefail
          ARCHIVE_DIR="release-artifacts"
          ARCHIVE_NAME="app-${GITHUB_REF_NAME}.tar.gz"
          mkdir -p "$ARCHIVE_DIR"

          declare -a build_dirs=()
          for dir in .next dist build; do
            if [ -d "$dir" ]; then
              build_dirs+=("$dir")
            fi
          done

          if [ "${#build_dirs[@]}" -eq 0 ]; then
            echo "No build output directories were produced; nothing to package."
            echo "archive=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          tar --exclude='*.map' -czf "$ARCHIVE_DIR/$ARCHIVE_NAME" "${build_dirs[@]}"
          echo "archive=$ARCHIVE_DIR/$ARCHIVE_NAME" >> "$GITHUB_OUTPUT"

      - name: Attach archive to GitHub Release
        if: steps.package.outputs.archive != ''
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.package.outputs.archive }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
