# Project Map – Kotodama v1.3.0

High-level tour of the repository, updated for the current release.

---

## 1. Directory Overview

```
kotodama/
├── README.md                 # User-facing overview
├── docs/                     # Documentation hub (guides, reference, project notes)
├── package.json              # Scripts, dependencies, release metadata
├── public/                   # Manifest + static icons (PNG required before publishing)
├── scripts/                  # Build helpers (copy manifest/icons, generate assets)
├── src/                      # All extension source code
│   ├── api/                  # AI provider clients (OpenAI active, Gemini/Claude prototypes)
│   ├── background/           # Manifest V3 service worker
│   ├── components/           # Shared React components
│   ├── constants/            # Model metadata, design tokens
│   ├── content/              # Twitter/X DOM integration
│   ├── onboarding/           # First-run setup flow
│   ├── panel/                # Main compose & reply UI
│   ├── settings/             # Settings dashboard + brand voice manager
│   ├── storage/              # IndexedDB schema + encryption helpers
│   ├── styles/               # Global CSS + token definitions
│   └── types/                # Shared TypeScript interfaces
└── dist/                     # Build artifacts (created by `npm run build`)
```

### `src/` Highlights

| Path | Purpose |
|------|---------|
| `api/openai.ts` | Shipping OpenAI client with fallback logic |
| `api/gemini.ts`, `api/claude.ts` | Ready-to-wire clients for upcoming provider support |
| `background/service-worker.ts` | Message router, OpenAI invocation, storage access |
| `content/content-script.ts` | Injects panel iframe, handles context capture and insertion |
| `panel/Panel.tsx` | Main React component (prompting, reply templates, thread toggle) |
| `settings/Settings.tsx` | API key management, default model/voice, theme toggle |
| `settings/BrandVoiceManager.tsx` | Create/edit/delete brand voices with validation |
| `onboarding/Onboarding.tsx` | Two-step setup with tweet URL + Markdown import |
| `storage/db.ts` | Dexie schema for voices, history, user profiles |
| `storage/settings.ts` | Chrome storage wrapper with encryption |

---

## 2. Build Output Snapshot (`dist/`)

Generated by `npm run build` (or `npm run dev` in watch mode).

```
dist/
├── background.js         # Service worker bundle
├── commonjsHelpers.js    # Vite helper chunk
├── content.js            # Content script bundle
├── models.js             # Shared model metadata bundle
├── onboarding.js         # Onboarding UI
├── panel.js              # Panel UI
├── settings.js           # Settings/brand voice manager UI
├── index.js              # Shared vendor chunk
├── index.css             # Compiled Tailwind styles
├── manifest.json         # Copied from public/
├── icons/                # Copied from public/icons/
└── src/
    ├── onboarding/index.html
    ├── panel/index.html
    └── settings/index.html
```

---

## 3. Runtime Data Flow

```
Twitter/X Page
    └─ content-script.ts injects sparkle button + iframe
        └─ User opens panel (Panel.tsx)
            └─ chrome.runtime.sendMessage({ type: 'generate' })
                └─ service-worker.ts
                    ├─ Loads settings (encrypted OpenAI key, defaults)
                    ├─ Fetches brand voice from IndexedDB
                    └─ Calls OpenAI (generateWithOpenAI)
                        └─ Receives response → saves history (optional)
                └─ Panel renders suggestion + character counts
                    └─ User clicks "Insert to X"
                        └─ Panel posts message to iframe parent
                            └─ Content script injects text + hides panel
```

Key points:
- All data stays local except outbound HTTPS calls to OpenAI.
- Reply mode enriches prompts with captured tweet text + username.
- Generation history writes to IndexedDB only if `rememberHistory` is enabled.

---

## 4. Storage & Settings

| Storage | Contents |
|---------|----------|
| IndexedDB (`src/storage/db.ts`) | Brand voices, optional generation history, cached user profiles |
| Chrome storage (`src/storage/settings.ts`) | Encrypted API keys, UI preferences, default voice/model |

Encryption uses Web Crypto (AES-GCM) before persisting values. Keys are decrypted only inside the service worker.

---

## 5. Release & Tooling Notes

- **Build**: `npm run build` (production) / `npm run dev` (watch)
- **Quality**: `npm run type-check`, `npm run lint`, `npm test`
- **Release automation**: GitHub `release-please` manages version bumps, changelog, and tags.
- **Icons**: Current SVG placeholders must be replaced with PNG variants (16/32/48/128) prior to store submission.

---

Need more context? Pair this map with `docs/project/IMPLEMENTATION_SUMMARY.md` for status, `docs/guides/QUICKSTART.md` for setup, and `docs/reference/API_REFERENCE.md` for integration details.
