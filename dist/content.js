let r=null,b=null,m=null,g=!1;const R=300;function P(){const e=globalThis;return e.chrome?.runtime?e.chrome.runtime:e.browser?.runtime?e.browser.runtime:null}const f=P(),T=f?.getURL("icons/kotodama-button.svg")??"",L=`
  <svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M10 2L12 8L18 10L12 12L10 18L8 12L2 10L8 8L10 2Z" fill="currentColor"/>
  </svg>
`;function A(e=20){if(!T){const o=document.createElement("span");return o.innerHTML=L.trim(),o.style.display="inline-flex",o.style.pointerEvents="none",o}const t=document.createElement("img");return t.src=T,t.alt="Kotodama logo",t.width=e,t.height=e,t.style.display="block",t.style.pointerEvents="none",t}function C(){console.log("Kotodama content script loaded"),S()}function S(){if(console.time("[Kotodama Performance] Button injection"),document.querySelector(".kotodama-floating-button")){console.timeEnd("[Kotodama Performance] Button injection");return}const e=document.createElement("button");e.className="kotodama-floating-button",e.title="Compose with Kotodama",e.innerHTML="";const t=document.createElement("span");t.style.display="inline-flex",t.style.alignItems="center",t.style.justifyContent="center",t.appendChild(A(24)),e.append(t),Object.assign(e.style,{position:"fixed",top:"24px",right:"24px",display:"inline-flex",alignItems:"center",justifyContent:"center",width:"48px",height:"48px",padding:"0",borderRadius:"16px",border:"1px solid rgba(255, 255, 255, 0.2)",background:"linear-gradient(135deg, #1d9bf0, #ec4899)",cursor:"pointer",boxShadow:"0 8px 20px -4px rgba(29, 155, 240, 0.5), 0 4px 12px rgba(0, 0, 0, 0.1)",transition:"all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1)",outline:"none",zIndex:"9999",backdropFilter:"blur(8px)"});const o=e.querySelector("img, svg");o&&(o.style.filter="brightness(0) invert(1)"),e.addEventListener("mouseenter",()=>{e.style.transform="scale(1.1) rotate(5deg)",e.style.boxShadow="0 12px 28px -6px rgba(236, 72, 153, 0.6), 0 8px 16px rgba(0, 0, 0, 0.15)"}),e.addEventListener("mouseleave",()=>{e.style.transform="scale(1) rotate(0deg)",e.style.boxShadow="0 8px 20px -4px rgba(29, 155, 240, 0.5), 0 4px 12px rgba(0, 0, 0, 0.1)"}),e.addEventListener("click",async a=>{a.preventDefault(),a.stopPropagation(),console.log("[Kotodama] Floating button clicked, detecting context...");const l=['[data-testid="inlineReplyingTo"]','[aria-label*="Replying to"]',".css-1rynq56.r-bcqeeo.r-qvutc0.r-37j5jr.r-a023e6.r-rjixqe.r-16dba41.r-1awozwy.r-6koalj.r-1h0z5md.r-o7ynqc.r-clp7b1.r-3s2u2q"];let p=null;for(const x of l){const u=document.querySelector(x);if(u?.textContent?.includes("Replying to")){p=u;break}}const s=document.querySelector('[data-testid="tweetTextarea_0"]'),n=s?.getAttribute("data-text")||s?.getAttribute("placeholder")||s?.getAttribute("aria-label")||"",c=n.toLowerCase().includes("reply"),i=!!s?.closest('[data-testid="reply"]'),d=document.querySelectorAll('article[data-testid="tweet"]'),w=d.length>0,v=window.location.pathname.includes("/status/")&&s!==null;if(console.log("[Kotodama] Detection results:",{replyingToElement:!!p,isReplyPlaceholder:c,isInReplyContainer:i,hasTweetAbove:w,isReplyURL:v,placeholder:n.substring(0,50),tweetArticleCount:d.length}),p!==null||i||c&&n.toLowerCase().includes("post your reply")||v&&w)if(console.log("[Kotodama] Reply context detected"),b="reply",d.length>0){let x=d[0];for(let u=0;u<d.length;u++){const E=d[u];if(!E.contains(s)){x=E;break}}m=await extractTweetContextFromPage(x),console.log("[Kotodama] Extracted context:",m)}else console.warn("[Kotodama] Reply context detected but no tweet found"),m=null;else console.log("[Kotodama] Compose context (not a reply)"),b="compose",m=null;r&&document.body.contains(r)?q():k()}),document.body.appendChild(e),console.timeEnd("[Kotodama Performance] Button injection"),console.log("[Kotodama Performance] Floating button ready")}function k(){if(r){console.time("[Kotodama Performance] Panel show"),h(),setTimeout(()=>{console.timeEnd("[Kotodama Performance] Panel show")},R);return}if(!f){console.error("Kotodama: extension runtime is unavailable in this context.");return}console.time("[Kotodama Performance] Panel creation + first load"),r=document.createElement("iframe"),r.src=f.getURL("src/panel/index.html"),r.id="kotodama-panel";const e=window.innerWidth;let t,o,a,l;e<=1366?(t="min(420px, calc(100vw - 40px))",o="min(680px, calc(100vh - 80px))",a="80px",l="20px"):e<=1920?(t="min(480px, calc(100vw - 60px))",o="min(750px, calc(100vh - 100px))",a="80px",l="30px"):(t="min(540px, calc(100vw - 80px))",o="min(850px, calc(100vh - 120px))",a="90px",l="40px"),Object.assign(r.style,{position:"fixed",top:a,right:l,width:t,height:o,minHeight:"550px",border:"none",borderRadius:"24px",zIndex:"999999",boxShadow:"0 20px 60px -10px rgba(0, 0, 0, 0.4), 0 10px 30px -10px rgba(29, 155, 240, 0.2)",background:"transparent",overflow:"hidden",transform:"translateY(30px) scale(0.98)",opacity:"0",pointerEvents:"none",transition:"transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease"}),document.body.appendChild(r),requestAnimationFrame(()=>{h()}),r.addEventListener("load",()=>{console.timeEnd("[Kotodama Performance] Panel creation + first load"),K()})}function q(){r&&(g?y():(h(),K()))}const O=["https://twitter.com","https://x.com"];function I(e){return e.startsWith("chrome-extension://")||e.startsWith("moz-extension://")}function K(){if(!r?.contentWindow)return;const e=f?.getURL("").replace(/\/$/,"")||"*";r.contentWindow.postMessage({type:"context",context:b,tweetContext:m},e)}function h(){r&&(g=!0,r.style.pointerEvents="auto",r.style.transform="translateY(0)",r.style.opacity="1")}function y(){r&&(g=!1,r.style.pointerEvents="none",r.style.transform="translateY(24px)",r.style.opacity="0",setTimeout(()=>{!g&&r&&(r.style.pointerEvents="none")},R))}window.addEventListener("message",async e=>{const t=e.origin;if(I(t)||O.some(a=>t.startsWith(a))){if(e.data.type==="insert-tweet")F(e.data.content);else if(e.data.type==="close-panel")y();else if(e.data.type==="analyze-profile"){const a=await W(e.data.username),l=f?.getURL("").replace(/\/$/,"")||t;e.source?.postMessage({type:"profile-tweets",tweets:a},{targetOrigin:l})}}});function j(){const e=document.activeElement,t=['[data-testid="tweetTextarea_0"][contenteditable="true"]','[data-testid="tweetTextarea_0"] [contenteditable="true"]','[role="textbox"][contenteditable="true"]','[aria-label="Tweet text"][contenteditable="true"]','[aria-label="Post text"][contenteditable="true"]'];if(e)for(const o of t){if(e.matches(o))return e;const a=e.closest(o);if(a)return a}for(const o of t){const a=document.querySelector(o);if(a)return a}return null}function F(e){const t=j();if(!t){console.error("Could not find tweet compose box");return}console.log("[Kotodama] Inserting content:",e),t.focus();const o=window.getSelection();if(o){const n=document.createRange();n.selectNodeContents(t),o.removeAllRanges(),o.addRange(n)}let a=!1;if(typeof ClipboardEvent=="function"&&typeof DataTransfer=="function")try{const n=new DataTransfer;n.setData("text/plain",e);const c=new ClipboardEvent("paste",{bubbles:!0,cancelable:!0});Object.defineProperty(c,"clipboardData",{value:n,configurable:!0});const i=t.dispatchEvent(c);a=c.defaultPrevented||!i,console.log("[Kotodama] Paste event dispatched. Handled by X:",a)}catch(n){console.warn("[Kotodama] Clipboard paste simulation failed:",n)}const l=n=>n.replace(/\s+$/g,"").replace(/\r\n/g,`
`),p=()=>{if(console.log("[Kotodama] Using execCommand fallback insertion"),o){const n=document.createRange();n.selectNodeContents(t),o.removeAllRanges(),o.addRange(n)}try{t.dispatchEvent(new InputEvent("beforeinput",{bubbles:!0,cancelable:!0,inputType:"insertReplacementText",data:e}))}catch(n){console.warn("[Kotodama] beforeinput insertReplacementText failed:",n)}try{if(!document.execCommand("insertText",!1,e))throw new Error("execCommand insertText returned false")}catch(n){console.warn("[Kotodama] execCommand insertText fallback failed:",n),t.textContent=e}},s=()=>{const n=l(t.textContent||""),c=l(e);n!==c&&p(),t.setAttribute("data-text","true"),t.hasAttribute("aria-label")&&t.setAttribute("aria-label","Tweet text");try{t.dispatchEvent(new InputEvent("input",{bubbles:!0,cancelable:!0,data:e,inputType:a?"insertFromPaste":"insertReplacementText"}))}catch(d){console.warn("[Kotodama] input event failed:",d),t.dispatchEvent(new Event("input",{bubbles:!0}))}t.dispatchEvent(new Event("change",{bubbles:!0}));const i=window.getSelection();if(i){const d=document.createRange();d.selectNodeContents(t),d.collapse(!1),i.removeAllRanges(),i.addRange(d)}console.log("[Kotodama] Final content length:",t.textContent?.length),console.log("[Kotodama] Expected length:",e.length),console.log("[Kotodama] Match:",t.textContent===e),t.blur(),setTimeout(()=>{t.focus(),r&&setTimeout(()=>{y()},600)},50)};a?requestAnimationFrame(s):s()}async function W(e){const t=[],o=window.location.pathname;if(o===`/${e}`||o.startsWith(`/${e}/`)){const l=document.querySelectorAll('article[data-testid="tweet"]');for(const p of l){const s=p.querySelector('[data-testid="tweetText"]');if(s?.textContent){const n=s.textContent.trim();n.length>10&&n.length<=280&&t.push(n)}if(t.length>=20)break}}else try{const l=document.querySelectorAll('article[data-testid="tweet"]');for(const p of l){const s=p.querySelectorAll('a[role="link"][href^="/"]');let n=!1;for(const c of s){const i=c.getAttribute("href")||"";if(i===`/${e}`||i.startsWith(`/${e}/`)){n=!0;break}}if(n){const c=p.querySelector('[data-testid="tweetText"]');if(c?.textContent){const i=c.textContent.trim();i.length>10&&i.length<=280&&t.push(i)}}if(t.length>=20)break}}catch{}return t}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",C):C();
